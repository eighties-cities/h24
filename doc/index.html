
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://eighties-cities.github.io/h24/doc/">
      
      
        <link rel="prev" href="../workflows/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Documentation - About H24 library</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="/docs/css/moar.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#documentation-about-h24-library" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="About H24 library" class="md-header__button md-logo" aria-label="About H24 library" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            About H24 library
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Documentation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/eighties-cities/h24/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="About H24 library" class="md-nav__button md-logo" aria-label="About H24 library" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    About H24 library
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/eighties-cities/h24/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflows/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflows
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Documentation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Documentation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-generating-population" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1 Generating population
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-move-population" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2 Move population
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2 Move population">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-big-picture" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the "Big Picture"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the &#34;Big Picture&#34;">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-aggregatedcategories" class="md-nav__link">
    <span class="md-ellipsis">
      Building AggregatedCategories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-moves-for-aggregatedcategory" class="md-nav__link">
    <span class="md-ellipsis">
      Building moves for AggregatedCategory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpolate" class="md-nav__link">
    <span class="md-ellipsis">
      Interpolate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understanding-source-code-in-detail" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding source code in detail
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-simulating" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2 Simulating
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-generating-population" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1 Generating population
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-move-population" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2 Move population
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2 Move population">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-big-picture" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the "Big Picture"
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding the &#34;Big Picture&#34;">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-aggregatedcategories" class="md-nav__link">
    <span class="md-ellipsis">
      Building AggregatedCategories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-moves-for-aggregatedcategory" class="md-nav__link">
    <span class="md-ellipsis">
      Building moves for AggregatedCategory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpolate" class="md-nav__link">
    <span class="md-ellipsis">
      Interpolate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#understanding-source-code-in-detail" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding source code in detail
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-simulating" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2 Simulating
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="documentation-about-h24-library">Documentation about H24 library</h1>
<h2 id="step-1-generating-population">Step 1 Generating population</h2>
<p>Initial distribution of population (<code>population.bin</code>) is generated using the <code>PopulationGenerator</code> tools Object with correct input parameters/data :</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">rnd</span><span class="p">:</span><span class="w"> </span><span class="nc">Random</span><span class="p">,</span>
<span class="w">    </span><span class="n">irises</span><span class="p">:</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">AreaID</span><span class="p">],</span>
<span class="w">    </span><span class="n">geometry</span><span class="p">:</span><span class="w"> </span><span class="nc">AreaID</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Option</span><span class="p">[</span><span class="nc">MultiPolygon</span><span class="p">],</span>
<span class="w">    </span><span class="n">age10</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">AreaID</span><span class="p">,</span><span class="w"> </span><span class="nc">Vector</span><span class="p">[</span><span class="nc">Double</span><span class="p">]],</span>
<span class="w">    </span><span class="n">ageSex</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">AreaID</span><span class="p">,</span><span class="w"> </span><span class="nc">Vector</span><span class="p">[</span><span class="nc">Double</span><span class="p">]],</span>
<span class="w">    </span><span class="n">schoolAge</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">AreaID</span><span class="p">,</span><span class="w"> </span><span class="nc">Vector</span><span class="p">[</span><span class="nc">Double</span><span class="p">]],</span>
<span class="w">    </span><span class="n">educationSex</span><span class="p">:</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">AreaID</span><span class="p">,</span><span class="w"> </span><span class="nc">Vector</span><span class="p">[</span><span class="nc">Vector</span><span class="p">[</span><span class="nc">Double</span><span class="p">]]],</span>
<span class="w">    </span><span class="n">cells</span><span class="p">:</span><span class="w"> </span><span class="nc">STRtree</span><span class="p">):</span><span class="w"> </span><span class="nc">Seq</span><span class="p">[</span><span class="nc">Seq</span><span class="p">[</span><span class="nc">IndividualFeature</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cells</span><span class="p">.</span><span class="n">getRoot</span><span class="p">.</span><span class="n">getBounds</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Parameters of <code>eighties.h24.tools.PopulationGenerator</code></p>
<ul>
<li><code>c</code> shape of Iris,</li>
<li><code>p</code> &amp; <code>f</code> population structure and education from census,</li>
<li><code>g</code> population density in raster format,</li>
<li><code>s</code> grid size for population projection</li>
<li><code>r</code> if you want a random population</li>
</ul>
</div>
<p>Given population density we build a matrix of cells.</p>
<p>Next, the function <code>generation.generatePopulationRandomly</code> (generation.scala) use information about structure of population (age, sex, education) at the census block level (iris) to sample new population sized individuals using direct sampling algorithm.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">IndividualFeature</span><span class="p">(</span>
<span class="w">    </span><span class="n">ageCategory</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">sex</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">education</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span>
<span class="w">    </span><span class="n">location</span><span class="p">:</span><span class="w"> </span><span class="n">space</span><span class="p">.</span><span class="nc">Location</span><span class="p">)</span>
</code></pre></div>
<p>We don't consider the census block geometries, so we attribute for each individual (<code>IndividualFeature</code>) a random cell in a matrix of same size of the population raster grid. This random cell is taken using a multinomial to respect density of population.</p>
<p>Finally, individuals (x,y) are translated/relocated to some new grid of cells function of the <code>gridSize</code> parameter.</p>
<h2 id="step-2-move-population">Step 2 Move population</h2>
<h3 id="understanding-the-big-picture">Understanding the "Big Picture"</h3>
<h4 id="building-aggregatedcategories">Building AggregatedCategories</h4>
<p>We take a simple example extracted from a very simple EGT with only four people and a 4*4 grid of places.</p>
<p><img alt="move" src="../images/doc/move1.jpg" /></p>
<p>We start by building our aggregated categories using h24 <code>social.scala</code> package, using fine category described by EGT : </p>
<ul>
<li>John is a male of 24 years, with education coded as SUP</li>
<li>Paul is a male of 39 years, with education coded as SUP</li>
</ul>
<p>In h24 John and Paul are grouped in the same <code>aggregatedCategory</code> : {gender male ;30-59 years ;up education}  </p>
<p>If we look the grid we see the different places and activities that John, Paul practice for one day. We read this graphic like that : </p>
<ul>
<li>John stay at home (1,1) between 0h and 9h, then go to workplace (2,2) between 9h and 19h, and go back to home (1,1) at 19h. </li>
<li>Paul stay at home (2,2) between 0h and 6h, then go to workplace (3,0) between 6h and 15h, practice an activity (1,0) between 15h and 23h, then go back to home (2,2) at 23h.</li>
</ul>
<p>Now, if we look at (b) :</p>
<ul>
<li>Anna is a female of 22 years, with education coded as BAC</li>
<li>Lily is a female of 26 years, with education coded as BACP2</li>
</ul>
<p>We apply the same algorithm for Anna and Lily that are grouped in the same <code>aggregatedCategory</code> : {gender female ;15-29 years ;middle education}</p>
<p>We read the Timeslice and the Matrix of places and activities like (a).</p>
<h4 id="building-moves-for-aggregatedcategory">Building moves for AggregatedCategory</h4>
<p><img alt="move" src="../images/doc/move2.jpg" /></p>
<p>In this next step algorithm build move for each AggregatedCategory. To do that, we cumulate the time spent by each individual by cutting it into three time slice.</p>
<p>If we look at (a) : </p>
<ul>
<li>In the first [0h - 8h] time slice : </li>
<li>John stay at home during 8h in (1,1);</li>
<li>Paul stay at home during 6h in (0,3) and go to work during 2h in (2,2)</li>
</ul>
<p><strong>=&gt; for this time slice we aggregate these numbers in a list of [((place),hour);...]</strong> : [((2,2),8); ((0,3),6); ((2,2),2)]</p>
<ul>
<li>In the second [8h - 16h] time slice :</li>
<li>John stay at home during 1h in (1,1) then go to work 7h in (2,2)</li>
<li>Paul stay at work during 7h in (2,2) then go to activity 1h in (0,1)</li>
</ul>
<p><strong>=&gt; for this time slice we aggregate these numbers in a list of [((place),hour);...]</strong> : [((0,1),1); ((1,1),1); ((2,2),14)]</p>
<ul>
<li>In the third [16h - 24h] time slice :</li>
<li>John stay at work during 3h in (2,2) then go to home 5h in (1,1)</li>
<li>Paul stay at activy during 7h in (0,1) then go to home 1h in (0,3)</li>
</ul>
<p><strong>=&gt; for this time slice we aggregate these numbers in a list of [((place),hour);...]</strong> : [((0,1),7); ((0,3),1); ((1,1),5), ((2,2),3)]</p>
<p>These three list encode the <code>Moves</code> made by people of <code>AggregatedCategory {gender male ;30-59 years ;up education}</code> to <code>Cells</code> for each <code>Time Slice</code>. </p>
<p>We use the same algorithm for the other <code>AggregatedCategory</code> in (b)</p>
<h3 id="interpolate">Interpolate</h3>
<p>ECG contain only a small parts of the real population. We use a simple IDW (Inverse Distance Weighting) interpolation to compute values for all cells that contain actually no moves.</p>
<p><img alt="move" src="../images/doc/move3.png" /></p>
<p>If we consider starting from centroid of each cell : foulée.</p>
<ul>
<li>distance of 1 for horizontal and vertical move </li>
<li>distance of 1.41 for diagonal move</li>
</ul>
<p>In we compute the interpolated value for cell (1,1), with power 2, the computation with precision of 2 is :</p>
<p>((5/(1.41^2)) + (7/(1^2)) + (4/(1.41^2))) / ((1/(1.41^2)) + (1/(1^2)) + (1/(1.41^2))) ~= 5.76</p>
<p>You could also see in this figure the generalisation of the computation with a precision of 2.</p>
<h3 id="understanding-source-code-in-detail">Understanding source code in detail</h3>
<p>Using EGT and population previously generated, flows are precomputed as File (<code>move.bin</code>) before running simulation.</p>
<p>In <code>generation.scala</code> , in <code>flowsFromEgt(...)</code> the method <code>readFlowsFromEGT()</code> return an <code>Array[Flow]</code></p>
<p>We build a <code>MoveMatrix</code> (in reality a <code>Vector[TimeSlice, CellsMatrix]</code>) where <code>CellsMatrix</code> is an <code>Array[Array[Cell]]</code>  :</p>
<ul>
<li>A <code>Move</code> is an object with an index and a ratio.</li>
<li>A <code>Cell</code> is a Map which associate an <code>AggregatedCategory</code> with an array of <code>Move</code></li>
<li>An <code>AggregatedCategory</code> object take a category (ex.<code>Education.SUP</code>) as input and return the coresponding aggregated category (ex. <code>HIGH</code>)</li>
<li>A TimeSlice is a vector of TimeSlices (0-8,8-16,16-24) :<ul>
<li>(0-8) - Empty Map for each Cell in Matrix</li>
<li>(8-16) - Empty Map for each Cell in Matrix</li>
<li>(16-24) - Empty Map for each Cell in Matrix</li>
</ul>
</li>
</ul>
<p>We first build a vector of <code>MoveMatrix</code> with empty array of Move for AggregatedCategory.</p>
<p>For each <code>TimeSlice</code> by reading flows from EGT file (<code>Array[Flow]</code>) and aggregate them by Cell (<code>addFlowToCell</code> function).</p>
<div class="highlight"><pre><span></span><code>  for each nm in `Vector[TimeSlice, CellsMatrix]`  
   for each flow f in EGT  
     a) we get the Cell c at (x,y) of residence of current flow 
     b) we update these Cell c by calling addFlowToCell() function
</code></pre></div>
<p>The <code>addFlowToCell()</code> function add the contribution of a flow to <code>Cell</code> for a given timeslice by :
- computing the length of intersection between first <code>mn</code> timeslice and <code>f</code> timeslice.
- attributing an aggregated category <code>cat</code> to this flow.
- calculating :
    - if intersection is 0, cell <code>c</code> is not updated
    - else we create or update the <code>Array[Move]</code> for this <code>cat</code> .
    - If a <code>Move</code> already exist for the activity location of this flow, we update this Move by adding our contribution.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">addFlowToCell</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">Cell</span><span class="p">,</span><span class="w"> </span><span class="n">flow</span><span class="p">:</span><span class="w"> </span><span class="nc">Flow</span><span class="p">,</span><span class="w"> </span><span class="n">timeSlice</span><span class="p">:</span><span class="w"> </span><span class="nc">TimeSlice</span><span class="p">):</span><span class="w"> </span><span class="nc">Cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">intersection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">overlap</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">timeSlice</span><span class="p">,</span><span class="w"> </span><span class="n">timeSlice</span><span class="p">).</span><span class="n">toDouble</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">AggregatedSocialCategory</span><span class="p">(</span><span class="nc">SocialCategory</span><span class="p">(</span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flow</span><span class="p">.</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flow</span><span class="p">.</span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">education</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">flow</span><span class="p">.</span><span class="n">education</span><span class="p">))</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">intersection</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="n">c</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">c</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nc">Some</span><span class="p">(</span><span class="n">moves</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moves</span><span class="p">.</span><span class="n">indexWhere</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">Move</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">flow</span><span class="p">.</span><span class="n">activity</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">cat</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">moves</span><span class="p">.</span><span class="o">:+</span><span class="w"> </span><span class="p">(</span><span class="nc">Move</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">intersection</span><span class="p">.</span><span class="n">toFloat</span><span class="p">)))</span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MoveMatrix</span><span class="p">.</span><span class="nc">Move</span><span class="p">.</span><span class="n">ratio</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">moves</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
<span class="w">            </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">cat</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">moves</span><span class="p">.</span><span class="n">updated</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="w"> </span><span class="nc">Move</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">intersection</span><span class="p">.</span><span class="n">toFloat</span><span class="p">)))</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nc">None</span><span class="w"> </span><span class="o">=&gt;</span>
<span class="w">          </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">cat</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span><span class="nc">Move</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="n">activity</span><span class="p">,</span><span class="w"> </span><span class="n">intersection</span><span class="p">.</span><span class="n">toFloat</span><span class="p">)))</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>After that, MoveMatrix is interpolated (<code>interpolate(...)</code>) then normalized (<code>normalizedFlows(...)</code>).</p>
<p>Because EGT flows are a small parts of real flow, we scale MoveMatrix CellsMatrix build using EGT at IDF level by interpolating values to neighbors. Each CellsMatrix could be interpreted as a probability by category at individual level.</p>
<p>To normalize CellsMatrix, we use <code>getMovesFromOppositeSex(...)</code>: in order to get more samples in areas where we have little information, we also use the information from samples in the area with the same categories but different sex</p>
<h2 id="step-2-simulating">Step 2 Simulating</h2>
<ul>
<li>Chargement de <code>results/population.bin</code>   (ageCategory, sexe, education ) dans un vecteur d' <code>IndividualFeature</code></li>
<li>fct <code>generateWorld</code> :<ul>
<li><code>IndividualFeature</code> sont rewrappés dans des case class Age, Sexe, Education, Comportement, Lieu dans <code>Individual</code></li>
<li>On filtre cette population en fonction du prédicat de la fonction <code>included</code></li>
<li>Genere le monde <code>World</code> en fonction du vecteur <code>Individual</code>, fonction comportement de type <code>Behaviour</code> (double) et une graine  aléatoire. </li>
</ul>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>